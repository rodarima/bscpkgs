#!/bin/bash -ex

>&2 echo Running isolate stage1
>&2 echo PATH=$PATH

if [ -e /nix ]; then
  >&2 echo "/nix found, aborting"
  exit 1
fi

nixhome="@nixPrefix@/nix"
shell="@busybox@/bin/sh"
nixjoin="@nixPrefix@@nixtools@/bin/nix-join"


env=(
  PATH="@nixPrefix@@busybox@/bin:@busybox@/bin:@extraPath@"
  $(env | grep ^SLURM || true)
  $(env | grep ^GARLIC_OUT || true)
)

#-m @nixPrefix@ \
join_flags="-m /etc \
	-m /.statelite/tmpfs/etc \
	-m /sys \
	-m /var/run/munge \
	-m /gpfs/projects/bsc15 \
	-m /bin:@nixPrefix@@busybox@/bin"

exec $nixjoin -v -i $join_flags $nixhome -- \
	env -i "${env[@]}" @out@/bin/stage2
